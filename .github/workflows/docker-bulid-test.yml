name: CI & Dev Build

on:
  push:
    branches:
      - 'main' # 主分支推送触发测试
    tags-ignore:
      - 'v*' # 仅用于构建测试镜像, 忽略版本 Tag
  pull_request:

jobs:
  dev_build:
    runs-on: ubuntu-latest
    
    # 必须添加写入权限，否则无法推送到 GHCR
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =========================================================
      # 1. 动态设置镜像名 (优化逻辑)
      # =========================================================
      - name: Set up Docker Image Name
        run: |
          # 获取仓库名并转小写 (Docker 强制要求小写)
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          # 把 ghcr.io 前缀加上，确保后续 metadata 生成的每一条 tag 都是完整的
          echo "DOCKER_IMAGE=ghcr.io/${REPO_NAME}" >> $GITHUB_ENV
          echo "Target Image: ghcr.io/${REPO_NAME}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # =========================================================
      # 2. 生成标签 (自动处理 dev/feature 分支名)
      # =========================================================
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          # 直接使用包含 ghcr.io 的完整镜像名
          images: ${{ env.DOCKER_IMAGE }}
          # 配置你的 Tag 策略
          tags: |
            type=ref,event=branch
            # PR 事件生成 pr-xxx
            type=ref,event=pr
            # 每次 Push 都生成 commit hash tag, 方便回滚
            type=sha,format=long

      # =========================================================
      # 3. 登录 GitHub Container Registry
      # =========================================================
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # =========================================================
      # 4. 推送到 GitHub Container Registry
      # =========================================================      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          # 直接使用 metadata 生成的完整 tags 列表
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 建议开启缓存，加快构建速度
          cache-from: type=gha
          cache-to: type=gha,mode=max