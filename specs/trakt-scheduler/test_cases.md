# Trakt æ•°æ®åŒæ­¥å®šæ—¶ä»»åŠ¡ - æµ‹è¯•ç”¨ä¾‹è®¾è®¡

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

éªŒè¯ Trakt æ•°æ®åŒæ­¥åŠŸèƒ½çš„æ­£ç¡®æ€§ã€å¯é æ€§å’Œæ€§èƒ½ï¼Œç¡®ä¿ï¼š
1. OAuth2 æˆæƒæµç¨‹å®‰å…¨å¯é 
2. è°ƒåº¦å™¨å®šæ—¶ä»»åŠ¡å‡†ç¡®æ‰§è¡Œ
3. Trakt API å®¢æˆ·ç«¯ç¨³å®šé«˜æ•ˆ
4. æ•°æ®åŒæ­¥è½¬æ¢å‡†ç¡®æ— è¯¯
5. é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶å¥å…¨
6. å‰ç«¯é…ç½®ç•Œé¢åŠŸèƒ½å®Œæ•´

## ğŸ§ª æµ‹è¯•åˆ†ç±»

### 1. å•å…ƒæµ‹è¯• (Unit Tests)
é’ˆå¯¹å•ä¸ªå‡½æ•°æˆ–ç±»çš„ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡ã€‚

### 2. é›†æˆæµ‹è¯• (Integration Tests)
æµ‹è¯•æ¨¡å—é—´çš„äº¤äº’ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€å¤–éƒ¨APIæ¨¡æ‹Ÿç­‰ã€‚

### 3. ç«¯åˆ°ç«¯æµ‹è¯• (End-to-End Tests)
å®Œæ•´æµç¨‹æµ‹è¯•ï¼Œä»ç”¨æˆ·ç•Œé¢åˆ°åç«¯æœåŠ¡ã€‚

### 4. æ€§èƒ½æµ‹è¯• (Performance Tests)
éªŒè¯ç³»ç»Ÿæ€§èƒ½å’Œç¨³å®šæ€§ã€‚

## ğŸ”§ æµ‹è¯•ç¯å¢ƒè¦æ±‚

### æµ‹è¯•æ•°æ®åº“
- ä½¿ç”¨ SQLite å†…å­˜æ•°æ®åº“ (`:memory:`)
- æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹å‰åˆ›å»ºå¹²å‡€çš„æ•°æ®åº“
- æµ‹è¯•åæ¸…ç†æ‰€æœ‰æ•°æ®

### å¤–éƒ¨æœåŠ¡æ¨¡æ‹Ÿ
- Trakt API: ä½¿ç”¨ `responses` æˆ– `pytest-httpx` æ¨¡æ‹Ÿ
- Bangumi API: ä½¿ç”¨ç°æœ‰åŒæ­¥æœåŠ¡çš„æµ‹è¯•æ¨¡å¼
- OAuth å›è°ƒ: æ¨¡æ‹Ÿå®Œæ•´çš„æˆæƒæµç¨‹

### æµ‹è¯•é…ç½®
- ç‹¬ç«‹çš„æµ‹è¯•é…ç½®æ–‡ä»¶
- æ¨¡æ‹Ÿçš„ Trakt client_id å’Œ client_secret
- æµ‹è¯•ä¸“ç”¨çš„æ•°æ®åº“è·¯å¾„

## ğŸ“ æµ‹è¯•ç”¨ä¾‹è¯¦ç»†è®¾è®¡

### æµ‹è¯•ç»„ 1: OAuth2 æˆæƒæµç¨‹

#### 1.1 æˆæƒåˆå§‹åŒ–æµ‹è¯•
**æµ‹è¯•æ–‡ä»¶**: `tests/trakt/test_auth.py`
```python
def test_init_oauth_url_generation():
    """æµ‹è¯• OAuth æˆæƒ URL æ­£ç¡®ç”Ÿæˆ"""
    # è¾“å…¥: user_id = "test_user"
    # é¢„æœŸ: è¿”å›åŒ…å«æ­£ç¡®å‚æ•°çš„ Trakt OAuth URL
    # éªŒè¯: state å‚æ•°æ­£ç¡®ç”Ÿæˆå’Œå­˜å‚¨
    # éªŒè¯: redirect_uri ç¬¦åˆé…ç½®

def test_init_oauth_invalid_user():
    """æµ‹è¯•æ— æ•ˆç”¨æˆ·åˆå§‹åŒ– OAuth"""
    # è¾“å…¥: user_id = None æˆ–ç©ºå­—ç¬¦ä¸²
    # é¢„æœŸ: æŠ›å‡º ValidationError
```

#### 1.2 OAuth å›è°ƒå¤„ç†æµ‹è¯•
```python
def test_handle_callback_success():
    """æµ‹è¯•æˆåŠŸå¤„ç† OAuth å›è°ƒ"""
    # æ¨¡æ‹Ÿ: Trakt API è¿”å›æœ‰æ•ˆçš„ access_token å’Œ refresh_token
    # éªŒè¯: token æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
    # éªŒè¯: expires_at æ­£ç¡®è®¡ç®—
    # éªŒè¯: è¿”å›æˆåŠŸç»“æœ

def test_handle_callback_invalid_state():
    """æµ‹è¯• state å‚æ•°éªŒè¯å¤±è´¥"""
    # è¾“å…¥: æ— æ•ˆæˆ–è¿‡æœŸçš„ state å‚æ•°
    # é¢„æœŸ: æŠ›å‡º SecurityError

def test_handle_callback_api_error():
    """æµ‹è¯• Trakt API è¿”å›é”™è¯¯"""
    # æ¨¡æ‹Ÿ: Trakt API è¿”å› 400 æˆ– 500 é”™è¯¯
    # é¢„æœŸ: æŠ›å‡º TraktAPIError
```

#### 1.3 Token åˆ·æ–°æµ‹è¯•
```python
def test_refresh_token_success():
    """æµ‹è¯•æˆåŠŸåˆ·æ–°è¿‡æœŸ token"""
    # å‡†å¤‡: æ•°æ®åº“ä¸­æœ‰è¿‡æœŸçš„ token
    # æ¨¡æ‹Ÿ: Trakt API è¿”å›æ–°çš„ token
    # éªŒè¯: æ–° token æ›´æ–°åˆ°æ•°æ®åº“
    # éªŒè¯: æ—§ token è¢«æ›¿æ¢

def test_refresh_token_still_valid():
    """æµ‹è¯•æœªè¿‡æœŸ token æ— éœ€åˆ·æ–°"""
    # å‡†å¤‡: æ•°æ®åº“ä¸­ token æœªè¿‡æœŸ
    # é¢„æœŸ: ç›´æ¥è¿”å› Trueï¼Œä¸è°ƒç”¨åˆ·æ–° API
```

### æµ‹è¯•ç»„ 2: Trakt API å®¢æˆ·ç«¯

#### 2.1 å®¢æˆ·ç«¯åˆå§‹åŒ–æµ‹è¯•
**æµ‹è¯•æ–‡ä»¶**: `tests/trakt/test_client.py`
```python
def test_client_init_with_valid_token():
    """æµ‹è¯•ä½¿ç”¨æœ‰æ•ˆ token åˆå§‹åŒ–å®¢æˆ·ç«¯"""
    # éªŒè¯: HTTP å®¢æˆ·ç«¯æ­£ç¡®é…ç½®
    # éªŒè¯: è¯·æ±‚å¤´åŒ…å«æ­£ç¡®çš„è®¤è¯ä¿¡æ¯

def test_client_rate_limit_handling():
    """æµ‹è¯•é€Ÿç‡é™åˆ¶å¤„ç†"""
    # æ¨¡æ‹Ÿ: Trakt API è¿”å› 429 çŠ¶æ€ç 
    # é¢„æœŸ: å®¢æˆ·ç«¯è‡ªåŠ¨ç­‰å¾…åé‡è¯•
    # éªŒè¯: é‡è¯•æ¬¡æ•°ç¬¦åˆé…ç½®
```

#### 2.2 API è¯·æ±‚æµ‹è¯•
```python
def test_get_watched_history_success():
    """æµ‹è¯•æˆåŠŸè·å–è§‚çœ‹å†å²"""
    # æ¨¡æ‹Ÿ: Trakt API è¿”å›æœ‰æ•ˆçš„è§‚çœ‹å†å²æ•°æ®
    # éªŒè¯: æ•°æ®æ­£ç¡®è§£æä¸º TraktHistoryItem åˆ—è¡¨
    # éªŒè¯: åˆ†é¡µå‚æ•°æ­£ç¡®ä¼ é€’

def test_get_watched_history_incremental():
    """æµ‹è¯•å¢é‡è·å–è§‚çœ‹å†å²"""
    # è¾“å…¥: start_date = ç‰¹å®šæ—¥æœŸ
    # éªŒè¯: API è¯·æ±‚åŒ…å« start_at å‚æ•°
    # éªŒè¯: åªè¿”å›æŒ‡å®šæ—¥æœŸåçš„è®°å½•

def test_get_watched_history_empty():
    """æµ‹è¯•ç©ºè§‚çœ‹å†å²"""
    # æ¨¡æ‹Ÿ: Trakt API è¿”å›ç©ºåˆ—è¡¨
    # é¢„æœŸ: è¿”å›ç©ºåˆ—è¡¨
```

#### 2.3 é”™è¯¯å¤„ç†æµ‹è¯•
```python
def test_client_network_error():
    """æµ‹è¯•ç½‘ç»œé”™è¯¯å¤„ç†"""
    # æ¨¡æ‹Ÿ: ç½‘ç»œè¿æ¥è¶…æ—¶
    # é¢„æœŸ: é‡è¯•æœºåˆ¶ç”Ÿæ•ˆ
    # éªŒè¯: è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åè¿”å› None

def test_client_authentication_error():
    """æµ‹è¯•è®¤è¯é”™è¯¯å¤„ç†"""
    # æ¨¡æ‹Ÿ: Trakt API è¿”å› 401 çŠ¶æ€ç 
    # é¢„æœŸ: æŠ›å‡º AuthenticationError
```

### æµ‹è¯•ç»„ 3: æ•°æ®åŒæ­¥æœåŠ¡

#### 3.1 åŒæ­¥æœåŠ¡åˆå§‹åŒ–æµ‹è¯•
**æµ‹è¯•æ–‡ä»¶**: `tests/trakt/test_sync_service.py`
```python
def test_sync_service_init():
    """æµ‹è¯•åŒæ­¥æœåŠ¡åˆå§‹åŒ–"""
    # éªŒè¯: ä¾èµ–çš„æœåŠ¡æ­£ç¡®æ³¨å…¥
    # éªŒè¯: å†…éƒ¨çŠ¶æ€æ­£ç¡®åˆå§‹åŒ–
```

#### 3.2 æ•°æ®è½¬æ¢æµ‹è¯•
```python
def test_convert_trakt_history_to_custom_item():
    """æµ‹è¯• Trakt å†å²è®°å½•è½¬æ¢ä¸º CustomItem"""
    # è¾“å…¥: å®Œæ•´çš„ TraktHistoryItem (episode ç±»å‹)
    # éªŒè¯: æ­£ç¡®è½¬æ¢ä¸º CustomItem
    # éªŒè¯: å­—æ®µæ˜ å°„æ­£ç¡® (title, season, episode, user_name)
    # éªŒè¯: åª’ä½“ç±»å‹æ­£ç¡®è®¾ç½®ä¸º "episode"

def test_convert_movie_history_skipped():
    """æµ‹è¯•ç”µå½±è®°å½•è¢«è·³è¿‡"""
    # è¾“å…¥: TraktHistoryItem (movie ç±»å‹)
    # é¢„æœŸ: è¿”å› None (ç›®å‰åªå¤„ç†å‰§é›†)
```

#### 3.3 å¢é‡åŒæ­¥é€»è¾‘æµ‹è¯•
```python
def test_should_sync_item_new():
    """æµ‹è¯•æ–°é¡¹ç›®åº”è¯¥åŒæ­¥"""
    # å‡†å¤‡: æ•°æ®åº“ä¸­æ— è¯¥é¡¹ç›®çš„åŒæ­¥å†å²
    # é¢„æœŸ: è¿”å› True

def test_should_sync_item_already_synced():
    """æµ‹è¯•å·²åŒæ­¥é¡¹ç›®åº”è¯¥è·³è¿‡"""
    # å‡†å¤‡: æ•°æ®åº“ä¸­æœ‰è¯¥é¡¹ç›®çš„åŒæ­¥å†å²
    # é¢„æœŸ: è¿”å› False
```

#### 3.4 æ‰¹é‡åŒæ­¥æµ‹è¯•
```python
def test_sync_user_trakt_data_success():
    """æµ‹è¯•æˆåŠŸåŒæ­¥ç”¨æˆ·æ•°æ®"""
    # å‡†å¤‡: ç”¨æˆ·æœ‰æœ‰æ•ˆçš„ Trakt é…ç½®
    # æ¨¡æ‹Ÿ: Trakt API è¿”å›è§‚çœ‹å†å²
    # æ¨¡æ‹Ÿ: ç°æœ‰åŒæ­¥æœåŠ¡æˆåŠŸå¤„ç† CustomItem
    # éªŒè¯: åŒæ­¥ç»“æœç»Ÿè®¡æ­£ç¡®
    # éªŒè¯: åŒæ­¥å†å²è®°å½•åˆ°æ•°æ®åº“

def test_sync_user_trakt_data_no_config():
    """æµ‹è¯•ç”¨æˆ·æ—  Trakt é…ç½®"""
    # å‡†å¤‡: ç”¨æˆ·æ—  Trakt é…ç½®
    # é¢„æœŸ: è¿”å›é”™è¯¯ç»“æœ
```

### æµ‹è¯•ç»„ 4: è°ƒåº¦å™¨åŠŸèƒ½

#### 4.1 è°ƒåº¦å™¨åˆå§‹åŒ–æµ‹è¯•
**æµ‹è¯•æ–‡ä»¶**: `tests/trakt/test_scheduler.py`
```python
def test_scheduler_start_stop():
    """æµ‹è¯•è°ƒåº¦å™¨å¯åŠ¨å’Œåœæ­¢"""
    # éªŒè¯: è°ƒåº¦å™¨æ­£ç¡®å¯åŠ¨
    # éªŒè¯: è°ƒåº¦å™¨æ­£ç¡®åœæ­¢
    # éªŒè¯: è°ƒåº¦å™¨çŠ¶æ€æ­£ç¡®æ›´æ–°
```

#### 4.2 å®šæ—¶ä»»åŠ¡ç®¡ç†æµ‹è¯•
```python
def test_add_user_job_success():
    """æµ‹è¯•æˆåŠŸæ·»åŠ ç”¨æˆ·å®šæ—¶ä»»åŠ¡"""
    # è¾“å…¥: user_id, cron_expression = "0 */6 * * *"
    # éªŒè¯: ä»»åŠ¡æ­£ç¡®æ·»åŠ åˆ°è°ƒåº¦å™¨
    # éªŒè¯: ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æ­£ç¡®è®¡ç®—

def test_remove_user_job():
    """æµ‹è¯•ç§»é™¤ç”¨æˆ·å®šæ—¶ä»»åŠ¡"""
    # å‡†å¤‡: å­˜åœ¨ç”¨æˆ·å®šæ—¶ä»»åŠ¡
    # æ‰§è¡Œ: ç§»é™¤ä»»åŠ¡
    # éªŒè¯: ä»»åŠ¡ä»è°ƒåº¦å™¨ä¸­ç§»é™¤
```

#### 4.3 ä»»åŠ¡æ‰§è¡Œæµ‹è¯•
```python
def test_sync_user_data_execution():
    """æµ‹è¯•å®šæ—¶ä»»åŠ¡æ‰§è¡Œç”¨æˆ·åŒæ­¥"""
    # å‡†å¤‡: ç”¨æˆ·å¯ç”¨ Trakt åŒæ­¥
    # æ¨¡æ‹Ÿ: è°ƒåº¦å™¨è§¦å‘ä»»åŠ¡æ‰§è¡Œ
    # éªŒè¯: sync_user_trakt_data è¢«è°ƒç”¨
    # éªŒè¯: æ‰§è¡Œç»“æœæ­£ç¡®è®°å½•
```

### æµ‹è¯•ç»„ 5: API æ¥å£

#### 5.1 é…ç½®æ¥å£æµ‹è¯•
**æµ‹è¯•æ–‡ä»¶**: `tests/trakt/test_api.py`
```python
def test_get_trakt_config_authenticated():
    """æµ‹è¯•è®¤è¯ç”¨æˆ·è·å– Trakt é…ç½®"""
    # å‡†å¤‡: ç”¨æˆ·å·²ç™»å½•ä¸”æœ‰ Trakt é…ç½®
    # è¯·æ±‚: GET /api/trakt/config
    # éªŒè¯: è¿”å›æ­£ç¡®çš„é…ç½®ä¿¡æ¯
    # éªŒè¯: å“åº”çŠ¶æ€ç  200

def test_update_trakt_config():
    """æµ‹è¯•æ›´æ–° Trakt é…ç½®"""
    # è¯·æ±‚: PUT /api/trakt/config
    # æ•°æ®: {"enabled": True, "sync_interval": "0 */6 * * *"}
    # éªŒè¯: é…ç½®æ­£ç¡®æ›´æ–°åˆ°æ•°æ®åº“
    # éªŒè¯: è°ƒåº¦å™¨ä»»åŠ¡ç›¸åº”æ›´æ–°
```

#### 5.2 åŒæ­¥æ¥å£æµ‹è¯•
```python
def test_manual_sync_trigger():
    """æµ‹è¯•æ‰‹åŠ¨è§¦å‘åŒæ­¥"""
    # è¯·æ±‚: POST /api/trakt/sync/manual
    # å‚æ•°: full_sync=False
    # éªŒè¯: è¿”å›ä»»åŠ¡ID
    # éªŒè¯: å¼‚æ­¥åŒæ­¥ä»»åŠ¡å¯åŠ¨

def test_get_sync_status():
    """æµ‹è¯•è·å–åŒæ­¥çŠ¶æ€"""
    # å‡†å¤‡: å­˜åœ¨åŒæ­¥ä»»åŠ¡
    # è¯·æ±‚: GET /api/trakt/sync/status/{task_id}
    # éªŒè¯: è¿”å›ä»»åŠ¡çŠ¶æ€ä¿¡æ¯
```

#### 5.3 æˆæƒæ¥å£æµ‹è¯•
```python
def test_auth_init_endpoint():
    """æµ‹è¯•æˆæƒåˆå§‹åŒ–æ¥å£"""
    # è¯·æ±‚: GET /api/trakt/auth/init
    # éªŒè¯: è¿”å› OAuth æˆæƒ URL
    # éªŒè¯: é‡å®šå‘åˆ° Trakt æˆæƒé¡µé¢

def test_auth_callback_endpoint():
    """æµ‹è¯•æˆæƒå›è°ƒæ¥å£"""
    # æ¨¡æ‹Ÿ: Trakt å›è°ƒè¯·æ±‚
    # è¯·æ±‚: GET /api/trakt/auth/callback?code=xxx&state=xxx
    # éªŒè¯: æ­£ç¡®å¤„ç†å›è°ƒï¼Œä¿å­˜ token
    # éªŒè¯: é‡å®šå‘åˆ°æˆåŠŸé¡µé¢
```

### æµ‹è¯•ç»„ 6: å‰ç«¯åŠŸèƒ½æµ‹è¯•

#### 6.1 é…ç½®ç•Œé¢æµ‹è¯•
**æµ‹è¯•æ–‡ä»¶**: `tests/trakt/test_frontend.py` (å¯èƒ½éœ€è¦ä½¿ç”¨ Playwright/Selenium)
```python
def test_config_page_load():
    """æµ‹è¯•é…ç½®é¡µé¢åŠ è½½"""
    # è®¿é—®: /trakt/config
    # éªŒè¯: é¡µé¢æ­£ç¡®æ¸²æŸ“
    # éªŒè¯: æ˜¾ç¤ºå½“å‰ Trakt è¿æ¥çŠ¶æ€
```

#### 6.2 æˆæƒæµç¨‹æµ‹è¯•
```python
def test_oauth_flow_in_browser():
    """æµ‹è¯•æµè§ˆå™¨ä¸­å®Œæ•´çš„ OAuth æµç¨‹"""
    # æ­¥éª¤1: ç‚¹å‡»"è¿æ¥ Trakt"æŒ‰é’®
    # æ­¥éª¤2: åœ¨æ–°çª—å£å®Œæˆ Trakt æˆæƒ
    # æ­¥éª¤3: è¿”å›é…ç½®é¡µé¢æ˜¾ç¤ºæˆæƒæˆåŠŸ
    # éªŒè¯: æ•´ä¸ªæµç¨‹æ— é”™è¯¯
```

## ğŸ§ª é›†æˆæµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: å®Œæ•´ç”¨æˆ·æ—…ç¨‹
```python
def test_complete_user_journey():
    """æµ‹è¯•ä»æˆæƒåˆ°å®šæœŸåŒæ­¥çš„å®Œæ•´æµç¨‹"""
    # 1. ç”¨æˆ·è®¿é—®é…ç½®é¡µé¢
    # 2. ç‚¹å‡»è¿æ¥ Traktï¼Œå®Œæˆ OAuth æˆæƒ
    # 3. é…ç½®åŒæ­¥é—´éš”ä¸ºæ¯2å°æ—¶
    # 4. ç­‰å¾…è°ƒåº¦å™¨è§¦å‘ç¬¬ä¸€æ¬¡åŒæ­¥
    # 5. éªŒè¯æ•°æ®æ­£ç¡®åŒæ­¥åˆ° Bangumi
    # 6. æŸ¥çœ‹åŒæ­¥å†å²è®°å½•
```

### åœºæ™¯ 2: é”™è¯¯æ¢å¤æµç¨‹
```python
def test_error_recovery_scenario():
    """æµ‹è¯•é”™è¯¯åœºæ™¯ä¸‹çš„æ¢å¤èƒ½åŠ›"""
    # 1. é…ç½®æœ‰æ•ˆçš„ Trakt è¿æ¥
    # 2. æ¨¡æ‹Ÿ Trakt API æš‚æ—¶ä¸å¯ç”¨
    # 3. è°ƒåº¦å™¨å°è¯•åŒæ­¥ï¼Œé‡åˆ°é”™è¯¯
    # 4. éªŒè¯é”™è¯¯è¢«æ­£ç¡®è®°å½•å’Œå¤„ç†
    # 5. æ¢å¤ Trakt API å¯ç”¨æ€§
    # 6. éªŒè¯ä¸‹ä¸€æ¬¡åŒæ­¥æˆåŠŸ
```

### åœºæ™¯ 3: å¤šç”¨æˆ·å¹¶å‘åŒæ­¥
```python
def test_concurrent_user_sync():
    """æµ‹è¯•å¤šä¸ªç”¨æˆ·åŒæ—¶åŒæ­¥"""
    # å‡†å¤‡: 3ä¸ªç”¨æˆ·éƒ½å¯ç”¨ Trakt åŒæ­¥
    # è§¦å‘: åŒæ—¶å¯åŠ¨æ‰‹åŠ¨åŒæ­¥
    # éªŒè¯: å¹¶å‘æ§åˆ¶ç”Ÿæ•ˆ
    # éªŒè¯: æ‰€æœ‰ç”¨æˆ·åŒæ­¥å®Œæˆ
    # éªŒè¯: æ— æ•°æ®æ··æ·†æˆ–ç«äº‰æ¡ä»¶
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç”¨ä¾‹

### 7.1 å¤§æ•°æ®é‡åŒæ­¥æµ‹è¯•
```python
def test_large_dataset_sync():
    """æµ‹è¯•åŒæ­¥å¤§é‡è§‚çœ‹å†å²è®°å½•"""
    # æ¨¡æ‹Ÿ: Trakt API è¿”å› 1000 æ¡è§‚çœ‹å†å²
    # æ‰§è¡Œ: åŒæ­¥ç”¨æˆ·æ•°æ®
    # æµ‹é‡: æ‰§è¡Œæ—¶é—´ã€å†…å­˜ä½¿ç”¨
    # éªŒè¯: æ‰€æœ‰è®°å½•æ­£ç¡®å¤„ç†
    # ç›®æ ‡: åŒæ­¥æ—¶é—´ < 60ç§’ï¼Œå†…å­˜å¢åŠ  < 100MB
```

### 7.2 é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§æµ‹è¯•
```python
def test_long_running_stability():
    """æµ‹è¯•è°ƒåº¦å™¨é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§"""
    # é…ç½®: è°ƒåº¦å™¨æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡åŒæ­¥
    # è¿è¡Œ: æŒç»­24å°æ—¶
    # ç›‘æ§: å†…å­˜æ³„æ¼ã€ä»»åŠ¡å †ç§¯ã€é”™è¯¯ç‡
    # éªŒè¯: 24å°æ—¶åç³»ç»Ÿä»ç„¶ç¨³å®šè¿è¡Œ
```

### 7.3 å¹¶å‘æ€§èƒ½æµ‹è¯•
```python
def test_concurrent_performance():
    """æµ‹è¯•é«˜å¹¶å‘ä¸‹çš„æ€§èƒ½è¡¨ç°"""
    # å‡†å¤‡: 10ä¸ªç”¨æˆ·åŒæ—¶å¯ç”¨åŒæ­¥
    # è§¦å‘: æ‰€æœ‰ç”¨æˆ·åŒæ—¶å¼€å§‹åŒæ­¥
    # æµ‹é‡: æ€»æ‰§è¡Œæ—¶é—´ã€æ•°æ®åº“è¿æ¥æ•°
    # éªŒè¯: ç³»ç»Ÿèµ„æºä½¿ç”¨åœ¨åˆç†èŒƒå›´å†…
```

## ğŸ”§ æµ‹è¯•å·¥å…·å’Œæ¡†æ¶

### æµ‹è¯•æ¡†æ¶
- **pytest**: ä¸»è¦æµ‹è¯•æ¡†æ¶
- **pytest-asyncio**: å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- **pytest-mock**: Mock å’Œ Patch æ”¯æŒ
- **pytest-cov**: ä»£ç è¦†ç›–ç‡

### Mock å’Œæ¨¡æ‹Ÿå·¥å…·
- **responses** æˆ– **pytest-httpx**: æ¨¡æ‹Ÿ HTTP è¯·æ±‚
- **unittest.mock**: Python æ ‡å‡†åº“ Mock
- **faker**: ç”Ÿæˆæµ‹è¯•æ•°æ®

### å‰ç«¯æµ‹è¯•å·¥å…·
- **Playwright** æˆ– **Selenium**: æµè§ˆå™¨è‡ªåŠ¨åŒ–
- **pytest-playwright**: Playwright é›†æˆ

### æ€§èƒ½æµ‹è¯•å·¥å…·
- **pytest-benchmark**: æ€§èƒ½åŸºå‡†æµ‹è¯•
- **memory-profiler**: å†…å­˜ä½¿ç”¨åˆ†æ

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ trakt/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py              # æµ‹è¯•é…ç½®å’Œfixture
â”‚   â”œâ”€â”€ test_auth.py             # OAuth2 æˆæƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_client.py           # Trakt API å®¢æˆ·ç«¯æµ‹è¯•
â”‚   â”œâ”€â”€ test_sync_service.py     # æ•°æ®åŒæ­¥æœåŠ¡æµ‹è¯•
â”‚   â”œâ”€â”€ test_scheduler.py        # è°ƒåº¦å™¨æµ‹è¯•
â”‚   â”œâ”€â”€ test_api.py              # API æ¥å£æµ‹è¯•
â”‚   â””â”€â”€ test_frontend.py         # å‰ç«¯åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ test_complete_flow.py    # å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ test_error_scenarios.py  # é”™è¯¯åœºæ™¯æµ‹è¯•
â””â”€â”€ performance/
    â”œâ”€â”€ test_large_data.py       # å¤§æ•°æ®é‡æµ‹è¯•
    â””â”€â”€ test_concurrent.py       # å¹¶å‘æ€§èƒ½æµ‹è¯•
```

## âš™ï¸ æµ‹è¯•é…ç½® (conftest.py)

```python
import pytest
import asyncio
from unittest.mock import Mock, AsyncMock
import sqlite3
import tempfile
import os

@pytest.fixture
def test_db():
    """åˆ›å»ºæµ‹è¯•æ•°æ®åº“"""
    # ä½¿ç”¨å†…å­˜æ•°æ®åº“æˆ–ä¸´æ—¶æ–‡ä»¶
    conn = sqlite3.connect(':memory:')
    # åˆ›å»ºæµ‹è¯•è¡¨ç»“æ„
    yield conn
    conn.close()

@pytest.fixture
def mock_trakt_api():
    """æ¨¡æ‹Ÿ Trakt API å“åº”"""
    with responses.RequestsMock() as rsps:
        # é…ç½®é»˜è®¤å“åº”
        yield rsps

@pytest.fixture
async def trakt_client():
    """åˆ›å»ºæµ‹è¯•ç”¨çš„ Trakt å®¢æˆ·ç«¯"""
    from app.services.trakt.client import TraktClient
    client = TraktClient(access_token="test_token")
    # é…ç½®æ¨¡æ‹Ÿçš„ HTTP å®¢æˆ·ç«¯
    yield client
    await client.close()

@pytest.fixture
def event_loop():
    """ä¸ºå¼‚æ­¥æµ‹è¯•åˆ›å»ºäº‹ä»¶å¾ªç¯"""
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    yield loop
    loop.close()
```

## ğŸš€ æµ‹è¯•æ‰§è¡Œå‘½ä»¤

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
pytest tests/ -v
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç»„
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/trakt/ -v

# è¿è¡Œé›†æˆæµ‹è¯•
pytest tests/integration/ -v

# è¿è¡Œæ€§èƒ½æµ‹è¯•
pytest tests/performance/ -v -m "performance"
```

### å¸¦è¦†ç›–ç‡æŠ¥å‘Š
```bash
pytest tests/ --cov=app.services.trakt --cov-report=html
```

### ç‰¹å®šæµ‹è¯•ç”¨ä¾‹
```bash
pytest tests/trakt/test_auth.py::test_init_oauth_url_generation -v
```

## ğŸ“ˆ æˆåŠŸæ ‡å‡†

### æµ‹è¯•é€šè¿‡ç‡
- å•å…ƒæµ‹è¯•é€šè¿‡ç‡: 100%
- é›†æˆæµ‹è¯•é€šè¿‡ç‡: 95%+
- ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡ç‡: 90%+

### ä»£ç è¦†ç›–ç‡
- è¯­å¥è¦†ç›–ç‡: 85%+
- åˆ†æ”¯è¦†ç›–ç‡: 80%+
- å‡½æ•°è¦†ç›–ç‡: 90%+

### æ€§èƒ½æŒ‡æ ‡
- å•ç”¨æˆ·åŒæ­¥æ—¶é—´: < 30ç§’ (100æ¡è®°å½•)
- å†…å­˜ä½¿ç”¨å¢åŠ : < 50MB
- å¹¶å‘ç”¨æˆ·æ”¯æŒ: â‰¥ 10ä¸ªç”¨æˆ·åŒæ—¶åŒæ­¥

### ç¨³å®šæ€§
- æ— å†…å­˜æ³„æ¼
- æ— ç«æ€æ¡ä»¶
- é”™è¯¯å¤„ç†è¦†ç›–ç‡: 100%

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actions å·¥ä½œæµ
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
      - run: uv sync --dev
      - run: pytest tests/ --cov --cov-report=xml
      - uses: codecov/codecov-action@v3
```

### æµ‹è¯•æŠ¥å‘Š
- æ¯æ¬¡æäº¤è‡ªåŠ¨è¿è¡Œæµ‹è¯•
- ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š
- ä¸Šä¼ åˆ° Codecov
- PR åˆå¹¶å‰è¦æ±‚æµ‹è¯•é€šè¿‡

## ğŸ“ æµ‹è¯•æ•°æ®ç®¡ç†

### æµ‹è¯•æ•°æ®é›†
```python
SAMPLE_TRAKT_HISTORY = {
    "id": 123456,
    "watched_at": "2024-01-15T20:30:00.000Z",
    "action": "scrobble",
    "type": "episode",
    "episode": {
        "season": 1,
        "number": 5,
        "title": "Pilot",
        "ids": {"trakt": 123}
    },
    "show": {
        "title": "Example Show",
        "original_title": "Example Show Original",
        "ids": {"trakt": 456}
    }
}
```

### æµ‹è¯•æ•°æ®å·¥å‚
```python
def create_trakt_history_item(**kwargs):
    """åˆ›å»ºæµ‹è¯•ç”¨çš„ TraktHistoryItem"""
    defaults = {
        "id": 1,
        "watched_at": "2024-01-01T00:00:00.000Z",
        "action": "scrobble",
        "type": "episode",
        "episode": {"season": 1, "number": 1, "title": "Test Episode"},
        "show": {"title": "Test Show"}
    }
    defaults.update(kwargs)
    return TraktHistoryItem(**defaults)
```

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### å¼‚æ­¥æµ‹è¯•é—®é¢˜
- ä½¿ç”¨ `pytest.mark.asyncio` è£…é¥°å™¨
- ç¡®ä¿æ­£ç¡®åˆ›å»ºå’Œæ¸…ç†äº‹ä»¶å¾ªç¯
- é¿å…åœ¨æµ‹è¯•ä¸­ä½¿ç”¨çœŸå®çš„ sleep()

### æ•°æ®åº“æµ‹è¯•é—®é¢˜
- æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥
- æµ‹è¯•å‰æ¸…ç†æ•°æ®ï¼Œæµ‹è¯•åå…³é—­è¿æ¥
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®éš”ç¦»

### Mock ç›¸å…³é—®é¢˜
- ç¡®ä¿ Mock è¦†ç›–äº†æ­£ç¡®çš„å¯¼å…¥è·¯å¾„
- å¼‚æ­¥å‡½æ•°ä½¿ç”¨ `AsyncMock`
- éªŒè¯ Mock è¢«è°ƒç”¨çš„æ¬¡æ•°å’Œå‚æ•°

## ğŸ”§ ç»´æŠ¤å’Œæ›´æ–°

### æµ‹è¯•ç»´æŠ¤ç­–ç•¥
1. **å®šæœŸæ›´æ–°**: æ¯æœˆå®¡æŸ¥å’Œæ›´æ–°æµ‹è¯•ç”¨ä¾‹
2. **è¦†ç›–ç‡ç›‘æ§**: æŒç»­ç›‘æ§ä»£ç è¦†ç›–ç‡å˜åŒ–
3. **æ€§èƒ½åŸºå‡†**: å»ºç«‹æ€§èƒ½åŸºå‡†å¹¶ç›‘æ§å›å½’
4. **æ–‡æ¡£åŒæ­¥**: æµ‹è¯•æ–‡æ¡£éšä»£ç å˜æ›´æ›´æ–°

### æ–°å¢åŠŸèƒ½æµ‹è¯•
1. ä¸ºæ–°åŠŸèƒ½ç¼–å†™æµ‹è¯•ç”¨ä¾‹
2. æ›´æ–°æµ‹è¯•æ–‡æ¡£
3. éªŒè¯ç°æœ‰æµ‹è¯•ä¸å—å½±å“
4. ç¡®ä¿æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡

---

**æœ€åæ›´æ–°**: 2026-01-23
**æµ‹è¯•è´Ÿè´£äºº**: Claude Code
**é¢„è®¡æµ‹è¯•å·¥ä½œé‡**: 3-5 äººå¤©
**æµ‹è¯•ä¼˜å…ˆçº§**: é«˜ (åŠŸèƒ½å®Œæ•´æ€§çš„å…³é”®)