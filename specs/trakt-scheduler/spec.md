# Trakt 数据同步定时任务功能规范

## 🎯 功能概述

为 Bangumi-syncer 项目添加定时任务功能，定期从 Trakt.tv 获取用户的观看记录、评分等数据，并同步到 Bangumi.tv。

## 📋 核心需求

### 1. 定时任务调度
- 实现可配置的定时任务调度系统
- 支持 Cron 表达式配置执行频率
- 支持手动触发立即执行
- 任务执行状态监控和日志记录

### 2. Trakt API 集成
- 实现 Trakt.tv OAuth2 认证
- 支持获取用户观看历史（watched history）
- 支持获取用户评分（ratings）
- 支持获取用户收藏（collection）
- 支持增量同步（仅同步最新数据）

### 3. Bangumi API 上报
- 将 Trakt 数据转换为 Bangumi 格式
- 支持批量上报到 Bangumi API
- 处理数据映射和转换（如剧集匹配）
- 支持上报状态跟踪和重试机制

### 4. 异步请求处理
- 使用 `httpx` 库进行异步 HTTP 请求
- 支持并发请求以提高性能
- 实现请求重试和错误处理
- 添加请求速率限制和退避策略

### 5. 配置管理
- 支持 Trakt API 凭据配置
- 支持同步频率配置
- 支持数据同步范围配置
- 配置项通过配置文件管理
- 用户查看和修改 Trakt 同步配置
- 配置包括同步间隔、启用/禁用状态等

### 6. 错误处理和监控
- 实现完善的错误处理机制
- 记录详细的执行日志
- 支持失败任务重试
- 提供任务执行状态报告

### 7.OAuth 授权流程
- 用户在前端点击 Trakt 授权按钮
- 后端生成 OAuth 授权 URL 并重定向用户到 Trakt
- 用户授权后，Trakt 回调后端并返回授权码
- 后端使用授权码换取 access_token 和 refresh_token
- 将 Token 信息保存到数据库的 trakt_config 表中

## 🔧 技术要求

### 技术栈遵循项目宪法
- **语言**: Python 3.9+
- **包管理**: `uv`
- **代码质量**: `ruff` (linting/formatting)
- **类型检查**: `ty` (严格类型提示)
- **核心库**: `httpx` (异步HTTP请求)

### 新增依赖要求
- `httpx` >= 0.25.0 - 异步HTTP客户端
- `apscheduler` >= 3.10.0 - 高级Python调度器
- `pydantic` >= 2.0.0 - 数据验证和设置管理
- 可选: `aiocron` 或 `schedule` 作为调度器备选方案

### 代码规范
- 所有函数必须包含完整的类型提示
- 遵循现有的项目架构和代码风格
- 使用现有的日志系统和配置管理
- 集成到现有的应用结构中

## 📁 文件结构变更

### 新增模块
```
app/scheduler/
├── __init__.py
├── core.py          # 调度器核心逻辑
├── jobs.py          # 任务定义
├── models.py        # 数据模型
└── config.py        # 调度器配置

app/services/
├── __init__.py
├── trakt_client.py  # Trakt API 客户端
├── bangumi_sync.py  # Bangumi 同步服务
└── data_mapper.py   # 数据映射转换

app/utils/
├── httpx_client.py  # 异步HTTP客户端工具
└── async_utils.py   # 异步工具函数
```

### 配置变更
- 更新 `config.ini` 添加调度器配置节
- 更新 `pyproject.toml` 添加新依赖
- 更新环境变量配置说明

## 🔄 工作流程

1. **初始化阶段**
   - 加载调度器配置
   - 初始化 Trakt 
   - 启动调度器

2. **定时执行阶段**
   - 调度器按配置频率触发同步任务
   - 调用 Trakt API 获取用户的观看历史
   - 遍历每条记录，转换为 CustomItem 格式, 并按照时间忽略上次已经处理过的数据.
   - 调用现有的 sync_custom_item_async() 方法同步到 Bangumi
   - 记录执行结果和统计信息

3. **监控和维护**
   - 监控任务执行状态
   - 处理执行失败的任务
   - 提供手动触发接口
   - 日志记录和报告生成

## ⚠️ 风险与考虑

### 技术风险
1. **API 限制**: Trakt 和 Bangumi API 都有请求频率限制
2. **数据一致性**: 需要处理同步过程中的数据一致性问题
3. **错误恢复**: 网络错误或API变更时的恢复机制
4. **性能影响**: 异步请求和大数据处理对性能的影响

### 安全考虑
1. **凭据存储**: 安全存储 Trakt OAuth2 令牌
2. **数据传输**: 确保API通信的安全性
3. **访问控制**: 合理的权限管理和访问控制

### 兼容性考虑
1. **向后兼容**: 不影响现有功能的正常运行
2. **配置迁移**: 现有用户的无缝升级体验
3. **依赖管理**: 新依赖与现有依赖的兼容性

## ✅ 验收标准

1. 调度器能够按配置频率正确执行任务
2. 能够成功从 Trakt API 获取用户数据
3. 数据能够正确转换并上报到 Bangumi
4. 异步请求正常工作，支持并发和错误处理
5. 配置系统完善，支持所有必要配置项
6. 错误处理机制健全，能够处理常见异常
7. 日志记录详细，便于问题排查
8. 代码符合项目代码规范和类型检查要求

## 📝 后续扩展

1. **Web界面**: 添加调度器管理界面
2. **更多数据源**: 支持其他平台数据同步
3. **高级功能**: 智能同步策略、数据统计分析
4. **通知系统**: 同步结果通知（邮件、Webhook等）

---

**备注**: 本规范遵循项目宪法要求，使用 `uv` 进行依赖管理，`ruff` 进行代码格式化，`ty` 进行类型检查。所有实现必须符合 Astral Stack 的最佳实践。